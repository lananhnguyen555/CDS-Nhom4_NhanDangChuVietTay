{% extends "base.html" %}

{% block title %}Flashcard - OCR Flashcard{% endblock %}

{% block extra_css %}
<style>
    .flashcard-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }
    
    .part-of-speech-badge {
        background: rgba(255,255,255,0.3);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .flashcard-single {
        display: none;
    }
    
    .flashcard-single.active {
        display: block;
    }
    
    .flashcard-single.hidden {
        display: none;
    }
    
    /* List view - hi·ªÉn th·ªã t·∫•t c·∫£ cards */
    #flashcard-display.list-view {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }
    
    #flashcard-display.list-view .flashcard-single {
        display: block !important;
    }
    
    #flashcard-display.list-view .flashcard-single.hidden {
        display: none !important;
    }
    
    #flashcard-display.list-view .flashcard-single.active {
        display: block !important;
    }
    
    #flashcard-display {
        position: relative;
        min-height: 500px;
    }
    
    #flashcard-display .flashcard {
        width: 100%;
        max-width: 700px;
        margin: 0 auto;
        perspective: 1000px;
        height: 500px;
    }
    
    #flashcard-display .flashcard-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }
    
    #flashcard-display .flashcard.flipped .flashcard-inner {
        transform: rotateY(180deg);
    }
    
    .flashcard-card {
        background: white;
        border-radius: 1rem;
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .flashcard-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .flashcard-card.flipped {
        transform: rotateY(180deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-layer-group"></i> Flashcard
            </h2>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <select id="category-filter" class="btn btn-outline" style="padding: 0.5rem 1rem; min-width: 150px;">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="noun">Danh t·ª´ (noun)</option>
                    <option value="verb">ƒê·ªông t·ª´ (verb)</option>
                    <option value="adjective">T√≠nh t·ª´ (adjective)</option>
                    <option value="adverb">Tr·∫°ng t·ª´ (adverb)</option>
                    <option value="pronoun">ƒê·∫°i t·ª´ (pronoun)</option>
                    <option value="preposition">Gi·ªõi t·ª´ (preposition)</option>
                    <option value="conjunction">Li√™n t·ª´ (conjunction)</option>
                    <option value="interjection">Th√°n t·ª´ (interjection)</option>
                </select>
                <button id="favorite-btn" class="btn btn-outline" onclick="toggleFavorites()" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-heart"></i> Y√™u th√≠ch
                </button>
                <button id="learned-btn" class="btn btn-outline" onclick="toggleLearned()" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-check-circle"></i> ƒê√£ h·ªçc
                </button>
                <button id="not-learned-btn" class="btn btn-outline" onclick="toggleNotLearned()" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-times-circle"></i> Ch∆∞a thu·ªôc
                </button>
                <div id="filter-count" style="color: var(--gray); font-size: 0.9rem;">
                    Hi·ªÉn th·ªã: <span id="count-number">{{ flashcards|length }}</span> th·∫ª | 
                    ƒê√£ h·ªçc: <span id="learned-count">0</span> | 
                    Ch∆∞a thu·ªôc: <span id="not-learned-count">0</span>
                </div>
                <button class="btn btn-outline" onclick="deleteAllFlashcards()" style="padding: 0.5rem 1rem; color: var(--danger); border-color: var(--danger);">
                    <i class="fas fa-trash-alt"></i> X√≥a t·∫•t c·∫£
                </button>
            </div>
        </div>

        <!-- Flashcard List View v·ªõi Navigation -->
        <div id="flashcard-container" style="max-width: 800px; margin: 0 auto;">
            {% if flashcards %}
            <!-- Navigation -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <button id="prev-btn" class="btn btn-outline" onclick="previousCard()" style="padding: 0.75rem 1.5rem; min-width: 120px;">
                    <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
                </button>
                <div style="text-align: center;">
                    <div id="card-counter" style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                        <span id="current-index">1</span> / <span id="total-count">{{ flashcards|length }}</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--gray); margin-top: 0.25rem;">Click th·∫ª ƒë·ªÉ l·∫≠t</div>
                </div>
                <button id="next-btn" class="btn btn-outline" onclick="nextCard()" style="padding: 0.75rem 1.5rem; min-width: 120px;">
                    Sau <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Single Flashcard Display -->
            <div id="flashcard-display">
                {% for card in flashcards %}
                <div class="flashcard-single {% if (request.args.get('id') and card.id|string == request.args.get('id')) or (not request.args.get('id') and loop.index == 1) %}active{% else %}hidden{% endif %}" 
                     data-id="{{ card.id }}" 
                     data-index="{{ loop.index0 }}"
                     data-category="{{ card.part_of_speech or card.category or 'noun' }}"
                     data-favorite="{{ 'true' if card.favorite else 'false' }}"
                     data-learned="{{ 'true' if card.get('learned') else 'false' }}"
                     data-not-learned="{{ 'true' if card.get('not_learned') else 'false' }}">
                    <div class="flashcard">
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                            <div style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                                <span class="part-of-speech-badge">{{ card.part_of_speech or 'noun' }}</span>
                            </div>
                            <div style="position: absolute; top: 1rem; left: 1rem; z-index: 10;">
                                <button class="btn btn-sm" onclick="event.stopPropagation(); toggleFavorite({{ card.id }})" style="background: rgba(255,255,255,0.2); color: {{ 'red' if card.favorite else 'white' }};">
                                    <i class="fas fa-heart{{ '' if card.favorite else '-o' }}"></i>
                                </button>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 2rem;">
                                <div class="flashcard-word" style="font-size: 4rem; font-weight: bold; margin-bottom: 1.5rem; text-align: center; word-break: break-word; line-height: 1.2;">
                                    {{ card.original }}
                                </div>
                                {% if card.pronunciation %}
                                <div style="font-size: 1.8rem; opacity: 0.95; margin-top: 0.5rem; font-style: italic; color: rgba(255,255,255,0.95); text-align: center;">
                                    {{ card.pronunciation }}
                                </div>
                                {% endif %}
                                {% if card.audio %}
                                <button onclick="event.stopPropagation(); playAudio('{{ card.audio }}')" style="margin-top: 2rem; background: rgba(255,255,255,0.25); border: none; color: white; padding: 1rem 2rem; border-radius: 0.5rem; cursor: pointer; font-size: 1.1rem; font-weight: bold;">
                                    <i class="fas fa-volume-up"></i> Ph√°t √¢m
                                </button>
                                {% else %}
                                <div style="font-size: 1.1rem; opacity: 0.8; margin-top: 2rem;">
                                    <i class="fas fa-volume-up"></i> Ph√°t √¢m
                                </div>
                                {% endif %}
                                <div style="margin-top: 2rem; font-size: 1rem; opacity: 0.9; text-align: center; font-weight: 500;">
                                    <i class="fas fa-hand-pointer"></i> Click ƒë·ªÉ xem chi ti·∫øt
                                </div>
                            </div>
                            <div class="flashcard-actions" style="position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); z-index: 10;">
                                <button class="btn btn-sm" onclick="event.stopPropagation(); editFlashcard({{ card.id }})" style="background: rgba(255,255,255,0.2); color: white; margin: 0 0.25rem;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); deleteFlashcard({{ card.id }})" style="background: rgba(255,255,255,0.2); color: white; margin: 0 0.25rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); markLearned({{ card.id }})" style="background: rgba(255,255,255,0.2); color: white; margin: 0 0.25rem;" title="ƒê√£ h·ªçc">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                <button class="btn btn-sm" onclick="event.stopPropagation(); markNotLearned({{ card.id }})" style="background: rgba(255,255,255,0.2); color: white; margin: 0 0.25rem;" title="Ch∆∞a thu·ªôc">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <div style="max-height: 500px; overflow-y: auto; width: 100%; padding: 0 0.5rem;">
                                <!-- AI Auto Flashcard Generator Badge -->
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <span style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 1rem; font-size: 0.85rem; font-weight: bold;">
                                        <i class="fas fa-robot"></i> AI Auto Flashcard Generator
                                    </span>
                                </div>

                                <!-- T·ª´ OCR -->
                                <div style="text-align: center; margin-bottom: 1.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">T·ª´ OCR ƒë∆∞·ª£c nh·∫≠n d·∫°ng:</div>
                                    <div style="font-size: 2rem; font-weight: bold;">{{ card.original }}</div>
                                </div>

                                <!-- Nghƒ©a ti·∫øng Vi·ªát -->
                                <div style="text-align: center; margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 0.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Nghƒ©a ti·∫øng Vi·ªát:</div>
                                    <div class="flashcard-meaning" style="font-size: 1.8rem; font-weight: bold;">{{ card.translated }}</div>
                                </div>

                                <!-- Phi√™n √¢m -->
                                {% if card.pronunciation %}
                                <div style="text-align: center; margin-bottom: 1.5rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Phi√™n √¢m:</div>
                                    <div style="font-size: 1.5rem; font-style: italic;">{{ card.pronunciation }}</div>
                                </div>
                                {% endif %}

                                <!-- V√≠ d·ª• -->
                                <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(255,255,255,0.15); border-radius: 0.5rem; border-left: 4px solid rgba(255,255,255,0.8);">
                                    <div style="font-size: 1rem; opacity: 0.95; margin-bottom: 1rem; font-weight: bold;">
                                        <i class="fas fa-quote-left"></i> V√≠ d·ª•:
                                    </div>
                                    {% if card.example %}
                                    <div style="font-size: 1.2rem; line-height: 1.8; font-style: italic; text-align: left; margin-bottom: 0.75rem;">
                                        "{{ card.example }}"
                                    </div>
                                    {% if card.example_translated %}
                                    <div style="font-size: 1rem; line-height: 1.6; text-align: left; opacity: 0.9; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                                        <i class="fas fa-language" style="margin-right: 0.5rem;"></i>{{ card.example_translated }}
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    <div style="font-size: 1rem; line-height: 1.6; opacity: 0.7; font-style: italic;">
                                        <i class="fas fa-info-circle"></i> Ch∆∞a c√≥ v√≠ d·ª• cho t·ª´ n√†y
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Audio ph√°t √¢m -->
                                {% if card.audio %}
                                <div style="text-align: center; margin-bottom: 1.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">Audio ph√°t √¢m:</div>
                                    <button onclick="event.stopPropagation(); playAudio('{{ card.audio }}')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-size: 1rem;">
                                        <i class="fas fa-volume-up"></i> Ph√°t √¢m
                                    </button>
                                </div>
                                {% endif %}

                                <!-- T·ª´ ƒë·ªìng nghƒ©a -->
                                {% if card.synonyms and card.synonyms|length > 0 %}
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.75rem;"><i class="fas fa-sync"></i> T·ª´ ƒë·ªìng nghƒ©a:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                        {% for syn in card.synonyms[:8] %}
                                        <span style="background: rgba(255,255,255,0.2); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.9rem;">{{ syn }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- T·ª´ tr√°i nghƒ©a -->
                                {% if card.antonyms and card.antonyms|length > 0 %}
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.75rem;"><i class="fas fa-exchange-alt"></i> T·ª´ tr√°i nghƒ©a:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                        {% for ant in card.antonyms[:8] %}
                                        <span style="background: rgba(255,255,255,0.2); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.9rem;">{{ ant }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Collocations -->
                                {% if card.collocations and card.collocations|length > 0 %}
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.75rem;"><i class="fas fa-link"></i> Collocations:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                                        {% for coll in card.collocations[:8] %}
                                        <span style="background: rgba(255,255,255,0.2); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.9rem;">{{ coll }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Notes -->
                                {% if card.notes %}
                                <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: 0.5rem;">
                                    <div style="font-size: 0.9rem; opacity: 0.9;"><i class="fas fa-info-circle"></i> {{ card.notes }}</div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flashcard-actions" style="margin-top: 1rem; position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);">
                                <button class="btn btn-sm" onclick="event.stopPropagation(); addToQuiz({{ card.id }})" style="background: rgba(255,255,255,0.2); color: white;">
                                    <i class="fas fa-question-circle"></i> Quiz
                                </button>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}

            {% endif %}
            
            {% if not flashcards %}
            <div style="text-align: center; padding: 4rem; color: var(--gray);">
                <i class="fas fa-inbox" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>Ch∆∞a c√≥ flashcard n√†o. H√£y b·∫Øt ƒë·∫ßu scan t·ª´ v·ª±ng!</p>
                <a href="/scan" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fas fa-camera"></i> Scan ngay
                </a>
            </div>
            {% endif %}
    </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; margin: 2rem;">
        <div class="card-header">
            <h3>Ch·ªânh s·ª≠a Flashcard</h3>
            <button onclick="closeEditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div style="padding: 1rem;">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">T·ª´ ti·∫øng Anh</label>
                <input type="text" id="edit-original" class="search-input" style="width: 100%;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Nghƒ©a ti·∫øng Vi·ªát</label>
                <input type="text" id="edit-translated" class="search-input" style="width: 100%;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Ghi ch√∫</label>
                <textarea id="edit-notes" class="search-input" style="width: 100%; min-height: 100px;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-primary" onclick="saveEdit()">L∆∞u</button>
                <button class="btn btn-outline" onclick="closeEditModal()">H·ªßy</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEditId = null;
let showFavoritesOnly = false;
let showLearnedOnly = false;
let showNotLearnedOnly = false;
let currentCardIndex = 0;
let allCards = []; // Ch·ª©a visible cards sau khi filter
let allCardsOriginal = []; // Ch·ª©a t·∫•t c·∫£ cards t·ª´ DOM (kh√¥ng filter)

// Kh·ªüi t·∫°o filter khi trang load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Initializing flashcard page...');
    
    // L·∫•y t·∫•t c·∫£ flashcard
    allCardsOriginal = Array.from(document.querySelectorAll('.flashcard-single'));
    allCards = [...allCardsOriginal]; // Copy ban ƒë·∫ßu
    console.log(`üìö Found ${allCardsOriginal.length} flashcard(s) in DOM`);
    
    if (allCardsOriginal.length === 0) {
        console.warn('‚ö†Ô∏è  No flashcards found in DOM');
        return;
    }
    
    // S·ª≠ d·ª•ng event delegation - ch·ªâ th√™m listener m·ªôt l·∫ßn cho container
    const flashcardDisplay = document.getElementById('flashcard-display');
    if (flashcardDisplay) {
        // Ki·ªÉm tra xem ƒë√£ c√≥ listener ch∆∞a (tr√°nh th√™m nhi·ªÅu l·∫ßn)
        if (!flashcardDisplay.hasAttribute('data-listener-added')) {
            flashcardDisplay.setAttribute('data-listener-added', 'true');
            
            // Th√™m event listener m·ªôt l·∫ßn cho container (event delegation)
            flashcardDisplay.addEventListener('click', function(e) {
                // Ch·ªâ x·ª≠ l√Ω khi click v√†o .flashcard
                const flashcard = e.target.closest('.flashcard');
                if (!flashcard) return;
                
                // N·∫øu click v√†o button ho·∫∑c action, kh√¥ng l·∫≠t th·∫ª
                if (e.target.closest('button') || e.target.closest('.flashcard-actions')) {
                    return;
                }
                
                flipCurrentCard(e);
            });
        }
    }
    
    // Category filter event listener
    const categoryFilter = document.getElementById('category-filter');
    if (categoryFilter) {
        // Ki·ªÉm tra xem ƒë√£ c√≥ listener ch∆∞a
        if (!categoryFilter.hasAttribute('data-listener-added')) {
            categoryFilter.setAttribute('data-listener-added', 'true');
            categoryFilter.addEventListener('change', function(e) {
                filterFlashcards(e.target.value);
            });
        }
    }
    
    // L·∫•y filter t·ª´ URL n·∫øu c√≥
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category');
    const favorite = urlParams.get('favorite');
    const cardId = urlParams.get('id');
    
    if (category && categoryFilter) {
        categoryFilter.value = category;
    }
    if (favorite === 'true') {
        showFavoritesOnly = true;
        const btn = document.getElementById('favorite-btn');
        if (btn) {
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
        }
    }
    
    // T√≠nh t·ªïng h·ª£p ban ƒë·∫ßu
    updateSummary();
    
    // √Åp d·ª•ng filter ban ƒë·∫ßu (m·∫∑c ƒë·ªãnh s·∫Ω hi·ªÉn th·ªã list view n·∫øu kh√¥ng c√≥ category filter)
    filterFlashcards();
    
    // ƒê·∫£m b·∫£o navigation lu√¥n ƒë∆∞·ª£c hi·ªÉn th·ªã (single card view v·ªõi navigation)
    const navigationDiv = document.querySelector('#flashcard-container > div:first-child');
    if (navigationDiv) {
        navigationDiv.style.display = 'flex'; // Lu√¥n hi·ªÉn th·ªã navigation
    }
    
    // N·∫øu c√≥ cardId, t√¨m v√† hi·ªÉn th·ªã card ƒë√≥ sau khi filter
    setTimeout(() => {
        if (cardId) {
            // T√¨m trong allCards ƒë√£ ƒë∆∞·ª£c filter
            const targetIndex = allCards.findIndex(card => card && card.dataset.id === cardId);
            if (targetIndex >= 0) {
                showCard(targetIndex);
            } else if (allCards.length > 0) {
                showCard(0);
            }
        } else if (allCards.length > 0) {
            showCard(0);
        }
    }, 100);
});

function updateSummary() {
    // D√πng allCardsOriginal ƒë·ªÉ t√≠nh t·ªïng h·ª£p (t·∫•t c·∫£ cards, kh√¥ng ch·ªâ visible)
    let learnedCount = 0;
    let notLearnedCount = 0;
    allCardsOriginal.forEach(card => {
        if (card && card.dataset.learned === 'true') learnedCount++;
        if (card && card.dataset.notLearned === 'true') notLearnedCount++;
    });
    const learnedEl = document.getElementById('learned-count');
    const notLearnedEl = document.getElementById('not-learned-count');
    if (learnedEl) learnedEl.textContent = learnedCount;
    if (notLearnedEl) notLearnedEl.textContent = notLearnedCount;
}

// Flip flashcard function
function flipCurrentCard(event) {
    // N·∫øu c√≥ event, t√¨m flashcard t·ª´ event target
    let flashcard = null;
    if (event) {
        // T√¨m element .flashcard g·∫ßn nh·∫•t t·ª´ event target
        flashcard = event.target.closest('.flashcard');
    }
    
    // N·∫øu kh√¥ng t√¨m ƒë∆∞·ª£c, t√¨m t·ª´ active card
    if (!flashcard) {
        const activeCard = document.querySelector('.flashcard-single.active');
        if (activeCard) {
            flashcard = activeCard.querySelector('.flashcard');
        }
    }
    
    if (flashcard) {
        flashcard.classList.toggle('flipped');
    } else {
        console.error('Kh√¥ng t√¨m th·∫•y flashcard ƒë·ªÉ l·∫≠t');
    }
}

// Category filter - ƒë√£ ƒë∆∞·ª£c g·ªôp v√†o DOMContentLoaded ch√≠nh ·ªü tr√™n

function toggleFavorites() {
    showFavoritesOnly = !showFavoritesOnly;
    const btn = document.getElementById('favorite-btn');
    if (showFavoritesOnly) {
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
    } else {
        btn.style.background = '';
        btn.style.color = '';
    }
    filterFlashcards();
}

function toggleLearned() {
    showLearnedOnly = !showLearnedOnly;
    showNotLearnedOnly = false; // T·∫Øt filter ch∆∞a thu·ªôc
    const btn = document.getElementById('learned-btn');
    const notLearnedBtn = document.getElementById('not-learned-btn');
    if (showLearnedOnly) {
        btn.style.background = '#10b981';
        btn.style.color = 'white';
    } else {
        btn.style.background = '';
        btn.style.color = '';
    }
    if (notLearnedBtn) {
        notLearnedBtn.style.background = '';
        notLearnedBtn.style.color = '';
    }
    filterFlashcards();
}

function toggleNotLearned() {
    showNotLearnedOnly = !showNotLearnedOnly;
    showLearnedOnly = false; // T·∫Øt filter ƒë√£ h·ªçc
    const btn = document.getElementById('not-learned-btn');
    const learnedBtn = document.getElementById('learned-btn');
    if (showNotLearnedOnly) {
        btn.style.background = '#ef4444';
        btn.style.color = 'white';
    } else {
        btn.style.background = '';
        btn.style.color = '';
    }
    if (learnedBtn) {
        learnedBtn.style.background = '';
        learnedBtn.style.color = '';
    }
    filterFlashcards();
}

function filterFlashcards(category = null) {
    const categoryFilterEl = document.getElementById('category-filter');
    if (!categoryFilterEl) {
        console.error('Category filter element not found');
        return;
    }
    
    const categoryFilter = category !== null ? category : categoryFilterEl.value;
    let visibleCards = [];
    
    // Lu√¥n d√πng allCardsOriginal ƒë·ªÉ filter (t·∫•t c·∫£ cards t·ª´ DOM)
    // C·∫≠p nh·∫≠t allCardsOriginal t·ª´ DOM tr∆∞·ªõc khi filter ƒë·ªÉ ƒë·∫£m b·∫£o data attributes m·ªõi nh·∫•t
    const flashcardDisplayEl = document.getElementById('flashcard-display');
    if (flashcardDisplayEl) {
        allCardsOriginal = Array.from(flashcardDisplayEl.querySelectorAll('.flashcard-single'));
    } else {
        allCardsOriginal = Array.from(document.querySelectorAll('.flashcard-single'));
    }
    
    console.log(`üîç Filtering ${allCardsOriginal.length} cards with category: ${categoryFilter || 'all'}`);
    
    allCardsOriginal.forEach(card => {
        // D√πng part_of_speech thay v√¨ category
        const cardPartOfSpeech = card.dataset.category || 'noun';
        const isFavorite = card.dataset.favorite === 'true';
        const isLearned = card.dataset.learned === 'true';
        const isNotLearned = card.dataset.notLearned === 'true';
        
        // Ki·ªÉm tra filter part of speech
        // N·∫øu categoryFilter l√† r·ªóng ho·∫∑c null, hi·ªÉn th·ªã t·∫•t c·∫£ (matchCategory = true)
        let matchCategory = true;
        if (categoryFilter && categoryFilter !== '' && categoryFilter !== 'all') {
            matchCategory = cardPartOfSpeech === categoryFilter;
        }
        
        // Ki·ªÉm tra filter favorite
        let matchFavorite = true;
        if (showFavoritesOnly) {
            matchFavorite = isFavorite;
        }
        
        // Ki·ªÉm tra filter learned
        let matchLearned = true;
        if (showLearnedOnly) {
            // Ch·ªâ hi·ªÉn th·ªã card c√≥ learned = true v√† not_learned = false
            matchLearned = isLearned && !isNotLearned;
        }
        
        // Ki·ªÉm tra filter not learned
        let matchNotLearned = true;
        if (showNotLearnedOnly) {
            // Ch·ªâ hi·ªÉn th·ªã card c√≥ not_learned = true v√† learned = false
            matchNotLearned = isNotLearned && !isLearned;
        }
        
        // N·∫øu kh√¥ng c√≥ filter learned/not learned n√†o active, hi·ªÉn th·ªã t·∫•t c·∫£
        if (!showLearnedOnly && !showNotLearnedOnly) {
            matchLearned = true;
            matchNotLearned = true;
        }
        
        // L∆∞u card n·∫øu match t·∫•t c·∫£ filters
        if (matchCategory && matchFavorite && matchLearned && matchNotLearned) {
            visibleCards.push(card);
        }
    });
    
    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã
    const countNumberEl = document.getElementById('count-number');
    const totalCountEl = document.getElementById('total-count');
    if (countNumberEl) countNumberEl.textContent = visibleCards.length;
    if (totalCountEl) totalCountEl.textContent = visibleCards.length;
    
    // C·∫≠p nh·∫≠t allCards ƒë·ªÉ ch·ªâ ch·ª©a visible cards (sau khi filter)
    allCards = visibleCards;
    
    // C·∫≠p nh·∫≠t t·ªïng h·ª£p (d√πng allCardsOriginal - t·∫•t c·∫£ cards t·ª´ DOM)
    updateSummary();
    console.log(`‚úÖ Filtered to ${visibleCards.length} visible cards`);
    
    // Lu√¥n d√πng single card view v·ªõi navigation (Tr∆∞·ªõc-Sau)
    const flashcardDisplay = document.getElementById('flashcard-display');
    const navigationDiv = document.querySelector('#flashcard-container > div:first-child'); // Navigation div
    
    if (flashcardDisplay) {
        flashcardDisplay.classList.remove('list-view'); // ƒê·∫£m b·∫£o kh√¥ng d√πng list view
    }
    if (navigationDiv) {
        navigationDiv.style.display = 'flex'; // Lu√¥n hi·ªÉn th·ªã navigation
    }
    
    if (visibleCards.length > 0) {
        // ·∫®n t·∫•t c·∫£ cards tr∆∞·ªõc
        const allCardsInDOM = document.querySelectorAll('.flashcard-single');
        allCardsInDOM.forEach(card => {
            if (card) {
                card.classList.remove('active');
                card.classList.add('hidden');
            }
        });
        
        // Hi·ªÉn th·ªã card ƒë·∫ßu ti√™n trong danh s√°ch visible (single card view v·ªõi navigation)
        currentCardIndex = 0;
        setTimeout(() => {
            if (allCards.length > 0 && allCards[0]) {
                showCard(0);
            }
        }, 10);
    } else {
        // Hi·ªÉn th·ªã th√¥ng b√°o kh√¥ng c√≥ k·∫øt qu·∫£
        const container = document.getElementById('flashcard-container');
        const flashcardDisplay = document.getElementById('flashcard-display');
        
        if (flashcardDisplay) {
            flashcardDisplay.style.display = 'none';
        }
        
        let noResultsMsg = document.getElementById('no-results-msg');
        if (!noResultsMsg && container) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.id = 'no-results-msg';
            noResultsMsg.style.cssText = 'text-align: center; padding: 4rem; color: var(--gray);';
            noResultsMsg.innerHTML = `
                <i class="fas fa-search" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                <p>Kh√¥ng t√¨m th·∫•y flashcard n√†o v·ªõi b·ªô l·ªçc hi·ªán t·∫°i.</p>
            `;
            container.appendChild(noResultsMsg);
        }
    }
}

function showCard(index) {
    // Ki·ªÉm tra allCards c√≥ r·ªóng kh√¥ng
    if (!allCards || allCards.length === 0) {
        console.warn('Kh√¥ng c√≥ flashcard n√†o ƒë·ªÉ hi·ªÉn th·ªã');
        // N·∫øu kh√¥ng c√≥ visible cards, th·ª≠ query l·∫°i t·ª´ DOM
        const flashcardDisplayEl = document.getElementById('flashcard-display');
        if (flashcardDisplayEl) {
            allCards = Array.from(flashcardDisplayEl.querySelectorAll('.flashcard-single'));
            if (allCards.length === 0) {
                return;
            }
        } else {
            return;
        }
    }
    
    // Ki·ªÉm tra index h·ª£p l·ªá
    if (index < 0 || index >= allCards.length) {
        console.warn(`Index ${index} kh√¥ng h·ª£p l·ªá. T·ªïng s·ªë cards: ${allCards.length}`);
        if (allCards.length > 0) {
            index = 0; // Reset v·ªÅ 0 n·∫øu kh√¥ng h·ª£p l·ªá
        } else {
            return; // Kh√¥ng c√≥ cards ƒë·ªÉ hi·ªÉn th·ªã
        }
    }
    
    // ·∫®n T·∫§T C·∫¢ cards (k·ªÉ c·∫£ kh√¥ng trong allCards) ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªâ hi·ªÉn th·ªã 1 card
    const allCardsInDOM = document.querySelectorAll('.flashcard-single');
    allCardsInDOM.forEach(card => {
        if (card) {
            card.classList.remove('active');
            card.classList.add('hidden');
            // Reset flip state
            const flashcard = card.querySelector('.flashcard');
            if (flashcard) {
                flashcard.classList.remove('flipped');
            }
        }
    });
    
    // ·∫®n th√¥ng b√°o kh√¥ng c√≥ k·∫øt qu·∫£ n·∫øu c√≥
    const noResultsMsg = document.getElementById('no-results-msg');
    if (noResultsMsg) {
        noResultsMsg.remove();
    }
    
    const flashcardDisplay = document.getElementById('flashcard-display');
    if (flashcardDisplay) {
        flashcardDisplay.style.display = 'block';
    }
    
    // Hi·ªÉn th·ªã CH·ªà card t·∫°i index (ƒë·∫£m b·∫£o ch·ªâ c√≥ 1 card active)
    if (allCards[index]) {
        // ƒê·∫£m b·∫£o card v·∫´n c√≤n trong DOM
        if (!allCards[index].parentNode) {
            console.warn(`Card at index ${index} is not in DOM, refreshing allCards...`);
            const flashcardDisplayEl = document.getElementById('flashcard-display');
            if (flashcardDisplayEl) {
                allCards = Array.from(flashcardDisplayEl.querySelectorAll('.flashcard-single'));
                if (index >= allCards.length || !allCards[index]) {
                    console.error(`Cannot show card at index ${index}, total: ${allCards.length}`);
                    return;
                }
            } else {
                return;
            }
        }
        
        // X√≥a class hidden v√† th√™m active
        allCards[index].classList.remove('hidden');
        allCards[index].classList.add('active');
        currentCardIndex = index;
        
        // Event listener ƒë√£ ƒë∆∞·ª£c th√™m trong DOMContentLoaded, kh√¥ng c·∫ßn th√™m l·∫°i
        
        // C·∫≠p nh·∫≠t counter (d√πng index trong allCards ƒë√£ filter)
        const currentIndexEl = document.getElementById('current-index');
        const totalCountEl = document.getElementById('total-count');
        if (currentIndexEl) {
            currentIndexEl.textContent = index + 1;
        }
        if (totalCountEl) {
            totalCountEl.textContent = allCards.length;
        }
        
        // C·∫≠p nh·∫≠t n√∫t navigation
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        if (prevBtn) {
            prevBtn.disabled = (index === 0);
            prevBtn.style.opacity = (index === 0) ? '0.5' : '1';
            prevBtn.style.cursor = (index === 0) ? 'not-allowed' : 'pointer';
        }
        if (nextBtn) {
            nextBtn.disabled = (index >= allCards.length - 1);
            nextBtn.style.opacity = (index >= allCards.length - 1) ? '0.5' : '1';
            nextBtn.style.cursor = (index >= allCards.length - 1) ? 'not-allowed' : 'pointer';
        }
    }
}

function nextCard() {
    if (allCards.length === 0) {
        console.warn('Kh√¥ng c√≥ flashcard n√†o');
        return;
    }
    
    // T√¨m index c·ªßa card hi·ªán t·∫°i trong allCards (ƒë√£ filter)
    const currentCard = document.querySelector('.flashcard-single.active');
    if (!currentCard) {
        // N·∫øu kh√¥ng t√¨m th·∫•y active card, hi·ªÉn th·ªã card ƒë·∫ßu ti√™n
        showCard(0);
        return;
    }
    
    const currentId = currentCard.dataset.id;
    const currentIndex = allCards.findIndex(card => card && card.dataset.id === currentId);
    
    if (currentIndex >= 0 && currentIndex < allCards.length - 1) {
        showCard(currentIndex + 1);
    } else if (currentIndex < 0 && allCards.length > 0) {
        // N·∫øu kh√¥ng t√¨m th·∫•y trong allCards, hi·ªÉn th·ªã card ƒë·∫ßu ti√™n
        showCard(0);
    } else {
        console.warn('ƒê√£ ƒë·∫øn card cu·ªëi c√πng');
    }
}

function previousCard() {
    if (allCards.length === 0) {
        console.warn('Kh√¥ng c√≥ flashcard n√†o');
        return;
    }
    
    // T√¨m index c·ªßa card hi·ªán t·∫°i trong allCards (ƒë√£ filter)
    const currentCard = document.querySelector('.flashcard-single.active');
    if (!currentCard) {
        // N·∫øu kh√¥ng t√¨m th·∫•y active card, hi·ªÉn th·ªã card ƒë·∫ßu ti√™n
        showCard(0);
        return;
    }
    
    const currentId = currentCard.dataset.id;
    const currentIndex = allCards.findIndex(card => card && card.dataset.id === currentId);
    
    if (currentIndex > 0) {
        showCard(currentIndex - 1);
    } else if (currentIndex < 0 && allCards.length > 0) {
        // N·∫øu kh√¥ng t√¨m th·∫•y trong allCards, hi·ªÉn th·ªã card ƒë·∫ßu ti√™n
        showCard(0);
    } else {
        console.warn('ƒê√£ ƒë·∫øn card ƒë·∫ßu ti√™n');
    }
}

function toggleFavorite(id) {
    fetch(`/api/flashcard/${id}`, {
        method: 'GET'
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const favorite = !data.flashcard.favorite;
            return fetch(`/api/flashcard/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({favorite: favorite})
            });
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.success) {
            showToast(data.flashcard.favorite ? 'ƒê√£ th√™m v√†o y√™u th√≠ch' : 'ƒê√£ b·ªè y√™u th√≠ch', 'success');
            // C·∫≠p nh·∫≠t UI m√† kh√¥ng reload - s·ª≠a selector ƒë·ªÉ t√¨m ƒë√∫ng element
            const card = document.querySelector(`.flashcard-single[data-id="${id}"]`);
            if (card) {
                card.dataset.favorite = data.flashcard.favorite ? 'true' : 'false';
                const heartBtn = card.querySelector('button[onclick*="toggleFavorite"]');
                if (heartBtn) {
                    const heartIcon = heartBtn.querySelector('i');
                    if (heartIcon) {
                        if (data.flashcard.favorite) {
                            heartIcon.className = 'fas fa-heart';
                            heartBtn.style.color = 'red';
                        } else {
                            heartIcon.className = 'fas fa-heart-o';
                            heartBtn.style.color = 'white';
                        }
                    }
                }
                // √Åp d·ª•ng l·∫°i filter
                filterFlashcards();
            }
        }
    })
    .catch(err => {
        console.error('Error toggling favorite:', err);
        showToast('L·ªói khi c·∫≠p nh·∫≠t y√™u th√≠ch', 'error');
    });
}

function playAudio(audioUrl) {
    if (audioUrl) {
        const audio = new Audio(audioUrl);
        audio.play().catch(err => {
            console.error('Error playing audio:', err);
            showToast('Kh√¥ng th·ªÉ ph√°t audio', 'error');
        });
    } else {
        showToast('Kh√¥ng c√≥ audio cho t·ª´ n√†y', 'info');
    }
}

function markLearned(id) {
    fetch(`/api/flashcard/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({learned: true, not_learned: false})
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.success) {
            showToast('ƒê√£ ƒë√°nh d·∫•u l√† ƒë√£ h·ªçc', 'success');
            const card = document.querySelector(`.flashcard-single[data-id="${id}"]`);
            if (card) {
                card.dataset.learned = 'true';
                card.dataset.notLearned = 'false';
            }
            // C·∫≠p nh·∫≠t l·∫°i allCardsOriginal t·ª´ DOM v√† filter l·∫°i
            const flashcardDisplayEl = document.getElementById('flashcard-display');
            if (flashcardDisplayEl) {
                allCardsOriginal = Array.from(flashcardDisplayEl.querySelectorAll('.flashcard-single'));
            } else {
                allCardsOriginal = Array.from(document.querySelectorAll('.flashcard-single'));
            }
            filterFlashcards();
        }
    })
    .catch(err => {
        console.error('Error marking learned:', err);
        showToast('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'error');
    });
}

function markNotLearned(id) {
    fetch(`/api/flashcard/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({not_learned: true, learned: false})
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.success) {
            showToast('ƒê√£ ƒë√°nh d·∫•u l√† ch∆∞a thu·ªôc', 'success');
            const card = document.querySelector(`.flashcard-single[data-id="${id}"]`);
            if (card) {
                card.dataset.notLearned = 'true';
                card.dataset.learned = 'false';
            }
            // C·∫≠p nh·∫≠t l·∫°i allCardsOriginal t·ª´ DOM v√† filter l·∫°i
            const flashcardDisplayEl = document.getElementById('flashcard-display');
            if (flashcardDisplayEl) {
                allCardsOriginal = Array.from(flashcardDisplayEl.querySelectorAll('.flashcard-single'));
            } else {
                allCardsOriginal = Array.from(document.querySelectorAll('.flashcard-single'));
            }
            filterFlashcards();
        }
    })
    .catch(err => {
        console.error('Error marking not learned:', err);
        showToast('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'error');
    });
}

function editFlashcard(id) {
    currentEditId = id;
    fetch(`/api/flashcard/${id}`)
        .then(res => res.json())
        .then(data => {
            if (data && data.success) {
                const originalEl = document.getElementById('edit-original');
                const translatedEl = document.getElementById('edit-translated');
                const notesEl = document.getElementById('edit-notes');
                const modalEl = document.getElementById('edit-modal');
                
                if (originalEl) originalEl.value = data.flashcard.original || '';
                if (translatedEl) translatedEl.value = data.flashcard.translated || '';
                if (notesEl) notesEl.value = data.flashcard.notes || '';
                if (modalEl) modalEl.style.display = 'flex';
            }
        })
        .catch(err => {
            console.error('Error loading flashcard:', err);
            showToast('L·ªói khi t·∫£i th√¥ng tin flashcard', 'error');
        });
}

function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
    currentEditId = null;
}

function saveEdit() {
    if (!currentEditId) {
        showToast('Kh√¥ng c√≥ flashcard n√†o ƒë∆∞·ª£c ch·ªçn', 'error');
        return;
    }
    
    const originalEl = document.getElementById('edit-original');
    const translatedEl = document.getElementById('edit-translated');
    const notesEl = document.getElementById('edit-notes');
    
    if (!originalEl || !translatedEl) {
        showToast('L·ªói: Kh√¥ng t√¨m th·∫•y c√°c tr∆∞·ªùng nh·∫≠p li·ªáu', 'error');
        return;
    }
    
    fetch(`/api/flashcard/${currentEditId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            original: originalEl.value.trim(),
            translated: translatedEl.value.trim(),
            notes: notesEl ? notesEl.value.trim() : ''
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.success) {
            showToast('ƒê√£ c·∫≠p nh·∫≠t flashcard', 'success');
            closeEditModal();
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.error || 'L·ªói khi c·∫≠p nh·∫≠t flashcard', 'error');
        }
    })
    .catch(err => {
        console.error('Error saving flashcard:', err);
        showToast('L·ªói k·∫øt n·ªëi khi c·∫≠p nh·∫≠t', 'error');
    });
}

function deleteFlashcard(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a flashcard n√†y?')) return;
    
    fetch(`/api/flashcard/${id}`, {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.success) {
            showToast('ƒê√£ x√≥a flashcard', 'success');
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(data.error || 'L·ªói khi x√≥a flashcard', 'error');
        }
    })
    .catch(err => {
        console.error('Error deleting flashcard:', err);
        showToast('L·ªói k·∫øt n·ªëi khi x√≥a', 'error');
    });
}

function addToQuiz(id) {
    window.location.href = `/learn?mode=quiz&card=${id}`;
}

function deleteAllFlashcards() {
    if (!confirm('‚ö†Ô∏è  B·∫†N C√ì CH·∫ÆC MU·ªêN X√ìA T·∫§T C·∫¢ FLASHCARD?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        return;
    }
    
    // X√°c nh·∫≠n l·∫ßn 2
    if (!confirm('‚ö†Ô∏è  X√ÅC NH·∫¨N L·∫¶N CU·ªêI:\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ flashcard?')) {
        return;
    }
    
    showToast('ƒêang x√≥a t·∫•t c·∫£ flashcard...', 'info');
    
    fetch('/api/flashcards', {
        method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.success) {
            showToast('ƒê√£ x√≥a to√†n b·ªô flashcard', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'L·ªói khi x√≥a flashcard', 'error');
        }
    })
    .catch(err => {
        console.error('Error deleting all flashcards:', err);
        showToast('L·ªói k·∫øt n·ªëi khi x√≥a', 'error');
    });
}
</script>
{% endblock %}

