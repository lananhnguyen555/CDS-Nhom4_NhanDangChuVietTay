{% extends "base.html" %}

{% block title %}Trang chủ - OCR Flashcard{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Hero Section -->
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 4rem 2rem;">
        <h1 style="font-size: 3rem; margin-bottom: 1rem;">
            <i class="fas fa-book-reader"></i> Học từ vựng thông minh
        </h1>
        <p style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9;">
            Scan từ tiếng Anh → Nghĩa Tiếng Việt → Tạo Flashcard
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="/scan" class="btn btn-primary btn-lg">
                <i class="fas fa-camera"></i> Chụp ảnh / Scan
            </a>
            <label for="file-upload" class="btn btn-secondary btn-lg" style="cursor: pointer;">
                <i class="fas fa-image"></i> Tải ảnh từ thư viện
            </label>
            <input type="file" id="file-upload" accept="image/*" style="display: none;">
        </div>
    </div>

    <!-- Search Bar -->
    <div class="card">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-input" placeholder="Tìm kiếm từ vựng...">
        </div>
        <div id="search-results" style="display: none;"></div>
    </div>

    <!-- Daily Word -->
    {% if daily_word %}
    <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-star"></i> Từ mới hôm nay
            </h2>
        </div>
        <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 1rem;">
                {{ daily_word.original }}
            </div>
            <div style="font-size: 1.5rem; opacity: 0.9;">
                {{ daily_word.translated }}
            </div>
            {% if daily_word.notes %}
            <div style="margin-top: 1rem; font-size: 1rem; opacity: 0.8;">
                <i class="fas fa-info-circle"></i> {{ daily_word.notes }}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Flashcards -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-clock"></i> Flashcard gần đây
            </h2>
            <a href="/flashcards" class="btn btn-outline">
                Xem tất cả <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        {% if recent_flashcards %}
        <div class="grid grid-2">
            {% for card in recent_flashcards %}
            <div class="flashcard-item" style="background: var(--light); padding: 1.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s;" 
                 onclick="viewFlashcard({{ card.id }})">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">
                            {{ card.original }}
                        </div>
                        <div style="color: var(--gray);">
                            {{ card.translated }}
                        </div>
                    </div>
                    {% if card.favorite %}
                    <i class="fas fa-heart" style="color: var(--danger);"></i>
                    {% endif %}
                </div>
                <div style="display: flex; gap: 0.5rem; font-size: 0.9rem; color: var(--gray);">
                    <span><i class="fas fa-calendar"></i> {{ card.created_at }}</span>
                    {% if card.review_count > 0 %}
                    <span><i class="fas fa-redo"></i> {{ card.review_count }} lần</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--gray);">
            <i class="fas fa-inbox" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <p>Chưa có flashcard nào. Hãy bắt đầu scan từ vựng!</p>
        </div>
        {% endif %}
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-bolt"></i> Thao tác nhanh
            </h2>
        </div>
        <div class="grid grid-4">
            <a href="/flashcards" class="btn btn-outline" style="flex-direction: column; padding: 2rem;">
                <i class="fas fa-layer-group" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <span>Flashcard</span>
            </a>
            <a href="/learn" class="btn btn-outline" style="flex-direction: column; padding: 2rem;">
                <i class="fas fa-graduation-cap" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <span>Học tập</span>
            </a>
            <a href="/learn?mode=quiz" class="btn btn-outline" style="flex-direction: column; padding: 2rem;">
                <i class="fas fa-question-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <span>Quiz</span>
            </a>
            <a href="/learn?mode=typing" class="btn btn-outline" style="flex-direction: column; padding: 2rem;">
                <i class="fas fa-keyboard" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <span>Gõ từ</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query.length < 2) {
                if (resultsDiv) resultsDiv.style.display = 'none';
                return;
            }
            
            fetch(`/api/search?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    if (resultsDiv) {
                        if (data.success && data.flashcards.length > 0) {
                            resultsDiv.style.display = 'block';
                            resultsDiv.innerHTML = `
                                <div class="grid grid-2" style="margin-top: 1rem;">
                                    ${data.flashcards.map(card => `
                                        <div class="flashcard-item" style="background: var(--light); padding: 1rem; border-radius: 0.5rem; cursor: pointer;" 
                                             onclick="window.location.href='/flashcards?id=${card.id}'">
                                            <div style="font-weight: bold; color: var(--primary);">${card.original || ''}</div>
                                            <div style="color: var(--gray);">${card.translated || ''}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            resultsDiv.style.display = 'none';
                        }
                    }
                });
        });
    }

    // File upload
    const fileUpload = document.getElementById('file-upload');
    if (fileUpload) {
        fileUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Kiểm tra kích thước file (max 16MB)
                if (file.size > 16 * 1024 * 1024) {
                    showToast('File quá lớn. Kích thước tối đa: 16MB', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('image', file);
                
                showToast('Đang upload ảnh...', 'info');
                
                fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('Upload thành công!', 'success');
                        window.location.href = `/scan?image=${data.filename}&path=${encodeURIComponent(data.path)}`;
                    } else {
                        showToast(data.error || 'Lỗi upload ảnh', 'error');
                    }
                })
                .catch(err => {
                    console.error('Upload error:', err);
                    showToast('Lỗi kết nối khi upload', 'error');
                });
            }
        });
    }
});

function viewFlashcard(id) {
    // Chuyển đến trang flashcard và hiển thị card cụ thể
    window.location.href = `/flashcards?id=${id}`;
}
</script>
{% endblock %}
